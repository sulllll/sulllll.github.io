---
layout: single
title:  "ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ì´ˆ - 9(SpringSecurity ë‹¤ì‹œ ë³´ê¸°)"
categories: SpringBoot
tag: [SpringBoot,SpringSecurity]
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "docs"
---

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì •

â–¶ SecurityConfig

```java
@Configuration // ë¹ˆë“±ë¡(IoCê´€ë¦¬)
@EnableWebSecurity // ì‹œíë¦¬í‹° í•„í„°ê°€ ë“±ë¡ì´ ëœë‹¤.
@EnableGlobalMethodSecurity(prePostEnabled = true) // íŠ¹ì • ì£¼ì†Œë¡œ ì ‘ê·¼ì„ í•˜ë©´ ê¶Œí•œ ë° ì¸ì¦ì„ ë¯¸ë¦¬ ì²´í¬ í•˜ê² ë‹¤ëŠ” ëœ»
public class SecurityConfig extends WebSecurityConfigurerAdapter{

@Override
protected void configure(HttpSecurity http) throws Exception {
	http
		.csrf().disable() // csrf í† í° ë¹„í™œì„±í™”(í…ŒìŠ¤íŠ¸ì‹œ ê±¸ìš°ë‘ëŠ”ê²Œ ì¢‹ìŒ)
		.authorizeRequests()
			.antMatchers("/", "/auth/**", "/js/**", "/css/**", "/image/**")
			.permitAll()
			.anyRequest()
			.authenticated()
		.and()
			.formLogin()
			.loginPage("/auth/loginForm")
			.loginProcessingUrl("/auth/loginProc") // ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ í•´ë‹¹ ì£¼ì†Œë¡œ ìš”ì²­ì˜¤ëŠ” ë¡œê·¸ì¸ì„ ê°€ë¡œì±ˆë‹¤. ëŒ€ì‹  ë¡œê·¸ì¸ í•´ì¤€ë‹¤.
			.defaultSuccessUrl("/");	// ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ë˜ë©´ ì—¬ê¸°ë¡œ ì´ë™
	}
}
```

<br/>

## ë¹„ë°€ë²ˆí˜¸ í•´ì‰¬í™” í•˜ê¸°(ì•”í˜¸í™”)

â–¶ SecurityConfig

```java
@Configuration // ë¹ˆë“±ë¡(IoCê´€ë¦¬)
@EnableWebSecurity // ì‹œíë¦¬í‹° í•„í„°ê°€ ë“±ë¡ì´ ëœë‹¤.
@EnableGlobalMethodSecurity(prePostEnabled = true) // íŠ¹ì • ì£¼ì†Œë¡œ ì ‘ê·¼ì„ í•˜ë©´ ê¶Œí•œ ë° ì¸ì¦ì„ ë¯¸ë¦¬ ì²´í¬ í•˜ê² ë‹¤ëŠ” ëœ»
public class SecurityConfig extends WebSecurityConfigurerAdapter{

	@Bean
	public BCryptPasswordEncoder endcodePWD() {
		return new BCryptPasswordEncoder();
	}
}
```

- BCryptPasswordEncoder ê°ì²´ë¥¼ Bean ìœ¼ë¡œ ë“±ë¡
<br/>

â–¶ UserService

```java
@Autowired
private BCryptPasswordEncoder encoder;

@Transactional
public void íšŒì›ê°€ì…(User user) {
	String rawPassword = user.getPassword(); // 1234 ì›ë˜ ë¹„ë°€ë²ˆí˜¸
	String encPassword = encoder.encode(rawPassword); // í•´ì‰¬í™”
	user.setPassword(encPassword); // í•´ì‰¬í™” ëœ íŒ¨ìŠ¤ì›Œë“œë¡œ ì…‹
	user.setRole(RoleType.USER);
	userRepository.save(user);
}
```
<br/>

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ë¡œ ë¡œê·¸ì¸ í•˜ê¸°

â–¶ SecurityConfig

```java
@Configuration // ë¹ˆë“±ë¡(IoCê´€ë¦¬)
@EnableWebSecurity // ì‹œíë¦¬í‹° í•„í„°ê°€ ë“±ë¡ì´ ëœë‹¤.
@EnableGlobalMethodSecurity(prePostEnabled = true) // íŠ¹ì • ì£¼ì†Œë¡œ ì ‘ê·¼ì„ í•˜ë©´ ê¶Œí•œ ë° ì¸ì¦ì„ ë¯¸ë¦¬ ì²´í¬ í•˜ê² ë‹¤ëŠ” ëœ»
public class SecurityConfig extends WebSecurityConfigurerAdapter{

	// ì‹œíë¦¬í‹°ê°€ ëŒ€ì‹  ë¡œê·¸ì¸í•´ì£¼ëŠ”ë° passwordë¥¼ ê°€ë¡œì±„ê¸° í•˜ëŠ”ë°
	// í•´ë‹¹ passwordê°€ ë­˜ë¡œ í•´ì‰¬ê°€ ë˜ì–´ íšŒì›ê°€ì…ì´ ë˜ì—ˆëŠ”ì§€ ì•Œì•„ì•¼
	// ê°™ì€ í•´ì‰¬ë¡œ ì•”í˜¸í™”í•´ì„œ DBì— ìˆëŠ” í•´ì‰¬ë‘ ë¹„êµí•  ìˆ˜ ìˆìŒ.
	@Override
	protected void configure(AuthenticationManagerBuilder auth) throws Exception {
		auth.userDetailsService(principalDetailService).passwordEncoder(endcodePWD());
	}

	@Bean
	public BCryptPasswordEncoder endcodePWD() {
		return new BCryptPasswordEncoder();
	}
}
```
<br/>


â–¶ PrincipalDetail
```java
@Getter
public class PrincipalDetail implements UserDetails{

	private User user; // ì»´í¬ì§€ì…˜

	public PrincipalDetail(User user) {
		this.user = user;
	}

	@Override
	public String getPassword() {
		return user.getPassword();
	}

	@Override
	public String getUsername() {
		return user.getUsername();
	}

	// ê³„ì •ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ ë¦¬í„´í•œë‹¤.(true : ë§Œë£Œ ì•ˆë¨)
	@Override
	public boolean isAccountNonExpired() {
		return true;
	}

	// ê³„ì •ì´ ì ê²¨ìˆì§€ ì•Šì•˜ëŠ”ì§€ ë¦¬í„´í•œë‹¤.(true : ì ê¸°ì§€ ì•ŠìŒ)
	@Override
	public boolean isAccountNonLocked() {
		return true;
	}

	// ë¹„ë°€ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ ë¦¬í„´. (true : ë§Œë£Œì•ˆë¨)
	@Override
	public boolean isCredentialsNonExpired() {
		// TODO Auto-generated method stub
		return true;
	}

	// ê³„ì •ì´ í™œì„±í™”(ì‚¬ìš©ê°€ëŠ¥)ì¸ì§€ ë¦¬í„´í•œë‹¤. (true : í™œì„±í™”)
	@Override
	public boolean isEnabled() {
		// TODO Auto-generated method stub
		return true;
	}

	// ê³„ì •ì´ ê°–ê³ ìˆëŠ” ê¶Œí•œ ëª©ë¡ì„ ë¦¬í„´í•œë‹¤. (ê¶Œí•œì´ ì—¬ëŸ¬ê°œ ìˆì„ ìˆ˜ ìˆì–´ì„œ ë£¨í”„ë¥¼ ëŒì•„ì•¼ í•˜ëŠ”ë° ìš°ë¦¬ëŠ” í•œê°œë§Œ)
	@Override
	public Collection<? extends GrantedAuthority> getAuthorities() {

		Collection<GrantedAuthority> collectors = new ArrayList<>();
		collectors.add(() -> {return "ROLE_" + user.getRole();});

//		collectors.add(new GrantedAuthority () {
//			public String getAuthority() {
//				return "ROLE_" + user.getRole();	// ROLE_USER -> ROLE ê¼­ ë¶™ì—¬ì£¼ê¸°
//			}
//		});

		return collectors;
	}
}
```

UserDetailsë¥¼ implements í•˜ì—¬ ì‚¬ìš©í•œë‹¤

<br/>

### UserDetails

Securityì—ì„œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë‹´ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ UserDetails ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.

ì´ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê²Œ ë˜ë©´ ì´ì œ Security ì¸ì¦, ì¸ê°€ ê´€ë ¨ ì‘ì—…ì—ì„œ ìš°ë¦¬ê°€ êµ¬í˜„í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì—…í•˜ê²Œ ë  ê²ƒì´ë‹¤.

<br/><br/>

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°(í˜„ì¬ ì‚¬ìš©ì ì¡°íšŒ)

@AuthenticationPrincipal ì–´ë…¸í…Œì´ì…˜ì„ í™œìš©í•´ í˜„ì¬ì˜ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì–»ì–´ ì˜¨ë‹¤

```java
@PostMapping(value = "/api/board")
public ResponseDto<Integer> save(@RequestBody Board board, @AuthenticationPrincipal PrincipalDetail principal) {// title, content
	boardService.ê¸€ì“°ê¸°(board, principal.getUser());	// principal.getUser()ëŠ” í˜„ì¬ ì„¸ì…˜ì˜ ì•„ì´ë””ë¥¼ ì˜ë¯¸
	return new ResponseDto<Integer>(HttpStatus.OK.value(),1);
}
```

## ğŸ“‘ ì¶œì²˜
 - [ë©”íƒ€ì½”ë”©](https://www.youtube.com/c/%EB%A9%94%ED%83%80%EC%BD%94%EB%94%A9/playlists)